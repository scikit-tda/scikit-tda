
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>UMAP for Supervised Dimension Reduction and Metric Learning &#8212; scikit-tda 0.0.2 documentation</title>
    <link rel="stylesheet" href="../../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Using UMAP for Clustering" href="clustering.html" />
    <link rel="prev" title="Transforming New Data with UMAP" href="transform.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="clustering.html" title="Using UMAP for Clustering"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="transform.html" title="Transforming New Data with UMAP"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">scikit-tda 0.0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Libraries</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Libraries</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../kepler-mapper/index.html">KeplerMapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persim/index.html">Persim</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
</ul>

    
  </div>
</div>
  <h4>Previous topic</h4>
  <p class="topless"><a href="transform.html"
                        title="previous chapter">Transforming New Data with UMAP</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="clustering.html"
                        title="next chapter">Using UMAP for Clustering</a></p>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../index.html">Docs</a></li>
              
                <li><a href="../index.html">Libraries</a></li>
              
                <li><a href="index.html">UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction</a></li>
              
              <li>UMAP for Supervised Dimension Reduction and Metric Learning</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="umap-for-supervised-dimension-reduction-and-metric-learning">
<h1>UMAP for Supervised Dimension Reduction and Metric Learning<a class="headerlink" href="#umap-for-supervised-dimension-reduction-and-metric-learning" title="Permalink to this headline">¶</a></h1>
<p>While UMAP can be used for standard unsupervised dimension reduction the
algorithm offers significant flexibility allowing it to be extended to
perform other tasks, including making use of categorical label
information to do supervised dimension reduction, and even metric
learning. We’ll look at some examples of how to do that below.</p>
<p>First we will need to load some base libraries – <code class="docutils literal notranslate"><span class="pre">numpy</span></code>, obviously,
but also <code class="docutils literal notranslate"><span class="pre">mnist</span></code> to read in the Fashion-MNIST data, and matplotlib and
seaborn for plotting.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mnist</span> <span class="k">import</span> <span class="n">MNIST</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s1">&#39;poster&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Our example dataset for this exploration will be the <a class="reference external" href="https://github.com/zalandoresearch/fashion-mnist">Fashion-MNIST
dataset from Zalando
Research</a>. It is
desgined to be a drop-in replacement for the classic MNIST digits
dataset, but uses images of fashion items (dresses, coats, shoes, bags,
etc.) instead of handwritten digits. Since the images are more complex
it provides a greater challenge than MNIST digits. We can load it in
(after downloading the dataset) using the <a class="reference external" href="https://pypi.org/project/python-mnist/">mnist
library</a>. We can then package
up the train and test sets into one large dataset, normalise the values
(to be in the range [0,1]), and set up labels for the 10 classes.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mndata</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span><span class="s1">&#39;fashion-mnist/data/fashion&#39;</span><span class="p">)</span>
<span class="n">train</span><span class="p">,</span> <span class="n">train_labels</span> <span class="o">=</span> <span class="n">mndata</span><span class="o">.</span><span class="n">load_training</span><span class="p">()</span>
<span class="n">test</span><span class="p">,</span> <span class="n">test_labels</span> <span class="o">=</span> <span class="n">mndata</span><span class="o">.</span><span class="n">load_testing</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">train_labels</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">])</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;T-shirt/top&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Trouser&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Pullover&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Dress&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Coat&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Sandal&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Shirt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Sneaker&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Bag&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ankle boot&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Next we’ll load the <code class="docutils literal notranslate"><span class="pre">umap</span></code> library so we can do dimension reduction on
this dataset.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">umap</span>
</pre></div>
</div>
<div class="section" id="umap-on-fashion-mnist">
<h2>UMAP on Fashion MNIST<a class="headerlink" href="#umap-on-fashion-mnist" title="Permalink to this headline">¶</a></h2>
<p>First we’ll just do standard unsupervised dimension reduction using UMAP
so we have a baseline of what the results look like for later
comparison. This is simply a matter of instiantiating a <code class="xref py py-class docutils literal notranslate"><span class="pre">UMAP</span></code> object (in
this case setting the <code class="xref py py-attr docutils literal notranslate"><span class="pre">n_neighbors</span></code> parameter to be 5 – we are
interested mostly in very local information), then calling the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">fit_transform()</span></code> method with the data we wish to reduce. By default
UMAP reduces to two dimensions, so we’ll be able to view the results as
a scatterplot.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">embedding</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">1</span><span class="nb">min</span> <span class="mi">45</span><span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mf">7.22</span> <span class="n">s</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">1</span><span class="nb">min</span> <span class="mi">52</span><span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">1</span><span class="nb">min</span> <span class="mi">26</span><span class="n">s</span>
</pre></div>
</div>
<p>That took a little time, but not all that long considering it is 70,000
data points in 784 dimensional space. We can simply plot the results as
a scatterplot, colored by the class of the fashion item. We can use
matplotlibs colorbar with suitable tick-labels to give us the color key.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">embedding</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">boundaries</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fashion MNIST Embedded via UMAP&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/SupervisedUMAP_10_1.png" src="../../_images/SupervisedUMAP_10_1.png" />
<p>The result is fairly good. We successfully separated a number of the
classes, and the global structure (separating pants and footwear from
shirts, coats and dresses) is well preserved as well. Unlike results for
MNIST digits, however, there were a number of classes that did not
separate quite so cleanly. In particular T-shirts, shirts, dresses,
pullovers, and coats are all a little mixed. At the very least the
dresses are largely separated, and the T-shirts are mostly in one large
clump, but they are not well distinguished from the others. Worse still
are the coats, shirts, and pullovers (somewhat unsruprisingly as these
can certainly look very similar) which all have significant overlap with
one another. Ideally we would like much better class separation. Since
we have the label information we can actually give that to UMAP to use!</p>
</div>
<div class="section" id="using-labels-to-separate-classes-supervised-umap">
<h2>Using Labels to Separate Classes (Supervised UMAP)<a class="headerlink" href="#using-labels-to-separate-classes-supervised-umap" title="Permalink to this headline">¶</a></h2>
<p>How do we go about coercing UMAP to make use of target labels? If you
are familiar with the sklearn API you’ll know that the <code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code> method
takes a target parameter <code class="docutils literal notranslate"><span class="pre">y</span></code> that specifies supervised target
information (for example when training a supervised classification
model). We can simply pass the <code class="xref py py-class docutils literal notranslate"><span class="pre">UMAP</span></code> model that target data when
fitting and it will make use of it to perform supervised dimension
reduction!</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">embedding</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">3</span><span class="nb">min</span> <span class="mi">28</span><span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mf">9.17</span> <span class="n">s</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">3</span><span class="nb">min</span> <span class="mi">37</span><span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">2</span><span class="nb">min</span> <span class="mi">45</span><span class="n">s</span>
</pre></div>
</div>
<p>This took a little longer – both because we are using a larger
<code class="xref py py-obj docutils literal notranslate"><span class="pre">n_neighbors</span></code> value (which is suggested when doing supervised
dimension reduction; here we are using the default value of 15), and
because we need to condition on the label data. As before we have
reduced the data down to two dimensions so we can again visualize the
data with a scatterplot, coloring by class.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">embedding</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">boundaries</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fashion MNIST Embedded via UMAP using Labels&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/SupervisedUMAP_15_1.png" src="../../_images/SupervisedUMAP_15_1.png" />
<p>The result is a cleanly separated set of classes (and a little bit of
stray noise – points that were sufficiently different from their class
as to not be grouped with the rest). Aside from the clear class
separation however (which is expected – we gave the algorithm all the
class information), there are a couple of important points to note. The
first point to note is that we have retained the internal structure of
the individual classes. Both the shirts and pullovers still have the
distinct banding pattern that was visible in the original unsupervised
case; the pants, t-shirts and bags both retained their shape and
internal structure; etc. The second point to note is that we have also
retained the global structure. While the individual classes have been
cleanly seprated from one another, the inter-relationships among the
classes have been preserved: footwear classes are all near one another;
trousers and bags are at opposite sides of the plot; and the arc of
pullover, shirts, t-shirts and dresses is still in place.</p>
<p>The key point is this: the important structural properties of the data
have been retained while the known classes have been cleanly pulled
apart and isolated. If you have data with known classes and want to
seprate them while still having a meaningful embedding of individual
points then supervised UMAP can provide exactly what you need.</p>
</div>
<div class="section" id="using-partial-labelling-semi-supervised-umap">
<h2>Using Partial Labelling (Semi-Supervised UMAP)<a class="headerlink" href="#using-partial-labelling-semi-supervised-umap" title="Permalink to this headline">¶</a></h2>
<p>What if we only have some of our data labelled, however, and a number of
items are without labels. Can we still make use of the label information
we do have? This is now a semi-supervised learning problem, and yes, we
can work with those cases to. To set up the example we’ll mask some of
the target information – we’ll do this by using the sklearn standard of
having unlabelled point be given the label of -1 (such as, for example,
the noise points from a DBSCAN clustering).</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">masked_target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<span class="n">masked_target</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">70000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>Now that we have randomly masked some of the labels we can try to
perform supervised learning again. Everything works as before, but UMAP
will interpret the -1 label as beingan unlabelled point and learn
accordingly.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">fitter</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">masked_target</span><span class="p">)</span>
<span class="n">embedding</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">embedding_</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">3</span><span class="nb">min</span> <span class="mi">8</span><span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mf">7.85</span> <span class="n">s</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">3</span><span class="nb">min</span> <span class="mi">16</span><span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">2</span><span class="nb">min</span> <span class="mi">40</span><span class="n">s</span>
</pre></div>
</div>
<p>Again we can look at a scatterplot of the data colored by class.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">embedding</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">boundaries</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fashion MNIST Embedded via UMAP using Partial Labels&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/SupervisedUMAP_22_1.png" src="../../_images/SupervisedUMAP_22_1.png" />
<p>The result is much as we would expect – while we haven’t cleanly
separated the data as we did in the totally supervised case, the classes
have been made cleaner and more distinct. This semi-supervised approach
provides a powerful tool when labelling is potentially expensive, or
when you have more data than labels, but want to make use of that extra
data.</p>
</div>
<div class="section" id="training-with-labels-and-embedding-unlabelled-test-data-metric-learning-with-umap">
<h2>Training with Labels and Embedding Unlabelled Test Data (Metric Learning with UMAP)<a class="headerlink" href="#training-with-labels-and-embedding-unlabelled-test-data-metric-learning-with-umap" title="Permalink to this headline">¶</a></h2>
<p>If we have learned a supervised embedding, can we use that to embed new
previously unseen (and now unlabelled) points into the space? This would
provide an algorithm for <a class="reference external" href="https://en.wikipedia.org/wiki/Similarity_learning#Metric_learning">metric
learning</a>,
where we can use a labelled set of points to learn a metric on data, and
then use that learned metric as a measure of distance between new
unlabelled points. This can be particularly useful as part of a machine
learning pipline where we learn a supervised embedding as a form of
supervised feature engineering, and then build a classifier on that new
space – this is viable as long as we can pass new data to the embedding
model to be transformed to the new space.</p>
<p>To try this out with UMAP let’s use the train/test split provided by
Fashion MNIST:</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can fit a model to the training data, making use of the training
labels to learn a supervised embedding.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">mapper</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_labels</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">2</span><span class="nb">min</span> <span class="mi">18</span><span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mf">7.53</span> <span class="n">s</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">2</span><span class="nb">min</span> <span class="mi">26</span><span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">1</span><span class="nb">min</span> <span class="mi">52</span><span class="n">s</span>
</pre></div>
</div>
<p>Next we can use the <code class="xref py py-meth docutils literal notranslate"><span class="pre">transform()</span></code> method on that model to transform the
test set into the learned space. This time we won’t pass the label
information and let the model attempt to place the data correctly.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">test_embedding</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mf">17.3</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mi">986</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mf">18.3</span> <span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">15.4</span> <span class="n">s</span>
</pre></div>
</div>
<p>UMAP transforms are not as fast as some approaches, but as you can see
this was still fairly efficient. The important question is how well we
managed to embed the test data into the existing learned space. To start
let’s visualise the embedding of the training data so we can get a sense
of where things <em>should</em> go.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">mapper</span><span class="o">.</span><span class="n">embedding_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_labels</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">boundaries</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fashion MNIST Train Digits Embedded via UMAP Transform&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/SupervisedUMAP_31_0.png" src="../../_images/SupervisedUMAP_31_0.png" />
<p>As you can see this has done a similar job as before, successfully
embedding the separate classes while retaining both the internal
structure and the overall global structure. We can now look at how the
test set, for which we provided no label information, was embedded via
the <cite>:meth:`~umap.umap_.UMAP.transform</cite> method.</p>
<div class="code python3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">test_embedding</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_labels</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">boundaries</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fashion MNIST Train Digits Embedded via UMAP&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/SupervisedUMAP_33_0.png" src="../../_images/SupervisedUMAP_33_0.png" />
<p>As you can see we have replicated the layout of the training data,
including much of the internal structure of the classes. For the most
part assignment of new points follows the classes well. The greatest
source of confusion in some t-shirts that ended up in mixed with the
shirts, and some pullovers which are confused with the coats. Given the
difficulty of the problemn this is a good result, particularly when
compared with current state-of-the-art approaches such as <a class="reference external" href="https://github.com/adambielski/siamese-triplet/blob/master/Experiments_FashionMNIST.ipynb">siamese and
triplet
networks</a>.</p>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="transform.html" title="previous chapter (use the left arrow)">Transforming New Data with UMAP</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="clustering.html" title="next chapter (use the right arrow)">Using UMAP for Clustering</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="clustering.html" title="Using UMAP for Clustering"
             >next</a> |</li>
        <li class="right" >
          <a href="transform.html" title="Transforming New Data with UMAP"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">scikit-tda 0.0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Libraries</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2018, Nathaniel Saul. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>